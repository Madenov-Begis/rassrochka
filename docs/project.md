/**
 * @file: project.md
 * @description: Описание проекта, архитектура, модули, роли, бизнес-логика
 * @dependencies: -
 * @created: 2024-07-02
 */

# Мультитенантная система рассрочки для магазинов электроники

## Описание
Масштабируемая система для управления магазинами, клиентами и рассрочками. Поддерживает изоляцию данных, чёрный список, досрочное закрытие, разные роли пользователей и строгую модульность backend.

## Архитектура
- **Backend**: NestJS + Prisma + PostgreSQL
  - Строго модульная структура: каждый модуль — отдельная папка (controller, service, module, dto)
  - API разделено по ролям: `/api/admin/*` (админ), `/api/client/*` (магазин)
- **Frontend**: React + TailwindCSS + shadcn/ui + Zustand + TanStack Query
  - Без модульной структуры: компоненты в общих папках `pages/`, `components/`, `services/`, `store/`

## Основные модули backend
- **auth** — авторизация по login/password, определение роли
- **admin**
  - users — управление пользователями
  - stores — управление магазинами
  - stats — статистика по системе
- **client**
  - customers — клиенты магазина
  - installments — оформление и управление рассрочками
  - payments — платежи по рассрочкам
  - stats — статистика по магазину

## Роли и доступ
- **admin** — полный доступ к системе, управление магазинами и пользователями
- **store_manager** — доступ только к своему магазину, клиентам и рассрочкам

## Бизнес-логика
- Магазин может искать клиента по паспорту — видит только факт наличия чёрного списка/просрочек
- Досрочное закрытие: клиент может погасить основную сумму без процентов
- Состояния магазина: `active` (полный доступ), `payment_overdue` (только просмотр), `blocked` (доступ запрещён)
- Все действия логируются
- Магазин может добавить клиента в чёрный список (например, при мошенничестве или просрочках).
- Админ может только просматривать и анализировать чёрный список, но не вносит клиентов туда напрямую.
- При создании рассрочки магазин может проверить по паспорту, есть ли клиент в чёрном списке или с просрочками (без раскрытия деталей).
- Чёрный список реализован отдельной таблицей Blacklist, связанной с клиентом по паспортным данным.

## Безопасность и масштабируемость
- Изоляция данных между магазинами
- Проверка ролей и прав на каждом endpoint
- Логирование и аудит

## Чёрный список
- Для блокировки клиента используется только флаг isBlacklisted в таблице клиентов
- Таблица Blacklist не используется

## Аудит действий
- Все значимые действия пользователей (создание, изменение, удаление, вход, ошибки) логируются в отдельную таблицу AuditLog.
- Аудит позволяет отслеживать историю изменений и повышает безопасность системы.

## Цели
- Безопасность, масштабируемость, простота поддержки
- Чёткое разделение ролей и API
- Соответствие бизнес-процессам рассрочки

### Хуки и утилиты (frontend)

#### useDebounce
- Универсальный React-хук для дебаунса значения любого типа (например, для поиска, фильтрации, автокомплита)
- API: `const debouncedValue = useDebounce<T>(value: T, delay?: number)`
- Аргументы:
  - `value` — любое значение (generic)
  - `delay` — задержка в мс (по умолчанию 300)
- Возвращает: debouncedValue, обновляющийся только после задержки
- Пример:
  ```ts
  const [search, setSearch] = useState("");
  const debouncedSearch = useDebounce(search, 500);
  ```

#### Pagination (универсальный компонент)
- Переиспользуемый компонент серверной пагинации с иконками (shadcn/ui)
- API:
  - `page: number` — текущая страница
  - `total: number` — всего элементов
  - `limit?: number` — элементов на страницу (по умолчанию 10)
  - `onPageChange: (page: number) => void` — обработчик смены страницы
  - `className?: string` — стилизация
- Использует shadcn/ui Pagination, icon-кнопки, disable, расчёт totalPages
- Пример:
  ```tsx
  <Pagination page={page} total={total} limit={10} onPageChange={setPage} />
  ```
- Применён в админ-панели магазинов, рекомендуется для всех списков с серверной пагинацией

## Управление пользователями (admin/users)
- Универсальная форма UserForm для создания и редактирования пользователей.
- Поля: login (обяз.), роль, статус, магазин (для store_manager), password (обяз. при создании, опционален при редактировании).
- Валидация: login обязателен, пароль min 6 символов (только при создании обязателен), магазин обязателен для store_manager.
- В таблице и на странице пользователя статус отображается как цветной Badge, ID пользователя виден явно.
- Поиск по пользователям с debounce, пагинация через переиспользуемый компонент.
- PUT /admin/users/:id обновляет только переданные поля, включая пароль (с хешированием) и магазин (через data.store connect/disconnect).
- После успешного действия — toast, обновление данных, закрытие формы.
- Код чистый, без дублирования, с единым стилем, все импорты и типы приведены к корректному виду.

## Итог по админке
- Все функции управления пользователями реализованы: создание, редактирование, смена пароля, статусы, связь с магазином, валидация, UX.
- Используются современные UI-компоненты (shadcn/ui), адаптивность, UX.
- Код чистый, без дублирования, все импорты и типы приведены к корректному виду.
- Документация и changelog синхронизированы.
- Админка полностью соответствует ТЗ и стандарту проекта.

### API: Получение рассрочек клиента

Добавлен endpoint:
- `GET /api/client/customers/:id/installments` — возвращает все рассрочки клиента по id (только для текущего магазина).

Используется на детальной странице клиента для корректного отображения только его рассрочек.

### Глобальный поиск по паспорту
- Возвращает только магазины, где клиент либо в чёрном списке, либо с просрочкой
- На фронте результат отображается карточками: магазин, ФИО, статус, блокировка, список просрочек 

## Формат API-ответов

Все ответы backend теперь структурированы по единому стандарту:

- Успех:
  ```json
  { "success": true, "data": ..., "message": "..." }
  ```
- Ошибка:
  ```json
  { "success": false, "error": "Текст ошибки", "code": 400 }
  ```
- Ошибка валидации:
  ```json
  { "success": false, "error": "Ошибка валидации", "code": 422, "details": { ... } }
  ```

### Пагинация

Для всех методов, возвращающих список:
```json
{
  "success": true,
  "data": {
    "items": [...],
    "total": N,
    "page": N,
    "totalPages": N
  }
}
```

### Техническая реализация
- Глобальный интерцептор оборачивает все успешные ответы.
- Глобальный фильтр ошибок приводит все ошибки к единому формату.
- Тип ApiResponse на фронте полностью совместим с этим стандартом. 

## Преобразование id к number в контроллерах

- Все идентификаторы (id, storeId, customerId и др.), получаемые из params/query/body, преобразуются к типу number (`Number(id)`) непосредственно в контроллерах перед передачей в сервисы.
- Это необходимо для строгого соответствия типу Int в Prisma и предотвращения ошибок типов.
- Аналогично преобразуются все внешние ключи, если они приходят из строки.
- Решение принято после перехода на числовые id во всех моделях. 

## Детальная страница рассрочки (installments/[id])

На детальной странице рассрочки реализовано:
- Получение и отображение полной информации о рассрочке (клиент, сумма, срок, статус, график платежей)
- График платежей с возможностью оплаты каждого платежа (кнопка "Оплатить")
- Досрочное закрытие рассрочки (отдельная кнопка, подтверждение, расчёт остатка)
- Отображение истории платежей, статусов, дат оплаты
- Все действия с платежами (оплата, просмотр, история) временно реализуются через эту страницу, отдельный модуль payments не используется

API:
- GET /api/client/installments/:id — получить рассрочку
- GET /api/client/installments/:id/payments — получить график платежей
- PUT /api/client/payments/:id/mark-paid — отметить платёж как оплаченный
- PUT /api/client/installments/:id/pay-off-early — досрочное закрытие рассрочки

UI/UX:
- Для каждого платежа отображается статус, сумма, дата, кнопка оплаты (если "pending" или "overdue")
- Для досрочного закрытия — диалог с подтверждением и расчётом остатка
- Вся логика реализована в front/src/pages/store/installments/[id].tsx 