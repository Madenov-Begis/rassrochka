/**
 * @file: project.md
 * @description: Описание проекта, архитектура, модули, роли, бизнес-логика
 * @dependencies: -
 * @created: 2024-07-02
 */

# Мультитенантная система рассрочки для магазинов электроники

## Описание
Масштабируемая система для управления магазинами, клиентами и рассрочками. Поддерживает изоляцию данных, чёрный список, досрочное закрытие, разные роли пользователей и строгую модульность backend.

## Архитектура
- **Backend**: NestJS + Prisma + PostgreSQL
  - Строго модульная структура: каждый модуль — отдельная папка (controller, service, module, dto)
  - API разделено по ролям: `/api/admin/*` (админ), `/api/client/*` (магазин)
- **Frontend**: React + TailwindCSS + shadcn/ui + Zustand + TanStack Query
  - Без модульной структуры: компоненты в общих папках `pages/`, `components/`, `services/`, `store/`

## Основные модули backend
- **auth** — авторизация по login/password, определение роли
- **admin**
  - users — управление пользователями
  - stores — управление магазинами
  - stats — статистика по системе
- **client**
  - customers — клиенты магазина
  - installments — оформление и управление рассрочками
  - payments — платежи по рассрочкам (список, детали, календарь, оплата)
  - stats — статистика по магазину

## Роли и доступ
- **admin** — полный доступ к системе, управление магазинами и пользователями
- **store_manager** — доступ только к своему магазину, клиентам и рассрочкам

## Бизнес-логика
- Магазин может искать клиента по паспорту — видит только факт наличия чёрного списка/просрочек
- Досрочное закрытие: клиент может погасить основную сумму без процентов
- **Состояния магазина:**
  - `active` — магазин работает в полном объёме, все менеджеры могут авторизоваться и работать
  - `inactive` — магазин неактивен, все менеджеры этого магазина не могут войти в систему (авторизация запрещена, backend возвращает ошибку, frontend отображает текст ошибки)
- Все действия логируются
- Магазин может добавить клиента в чёрный список (например, при мошенничестве или просрочках)
- Админ может только просматривать и анализировать чёрный список, но не вносит клиентов туда напрямую.
- При создании рассрочки магазин может проверить по паспорту, есть ли клиент в чёрном списке или с просрочками (без раскрытия деталей).
- Чёрный список реализован отдельной таблицей Blacklist, связанной с клиентом по паспортным данным.
- В списках и фильтрах отображаются все магазины, независимо от статуса (active/inactive).

## Безопасность и масштабируемость
- Изоляция данных между магазинами
- Проверка ролей и прав на каждом endpoint
- Логирование и аудит

## Чёрный список
- Для блокировки клиента используется только флаг isBlacklisted в таблице клиентов
- Таблица Blacklist не используется

## Аудит действий
- Все значимые действия пользователей (создание, изменение, удаление, вход, ошибки) логируются в отдельную таблицу AuditLog.
- Аудит позволяет отслеживать историю изменений и повышает безопасность системы.

## Цели
- Безопасность, масштабируемость, простота поддержки
- Чёткое разделение ролей и API
- Соответствие бизнес-процессам рассрочки

### Хуки и утилиты (frontend)

#### useDebounce
- Универсальный React-хук для дебаунса значения любого типа (например, для поиска, фильтрации, автокомплита)
- API: `const debouncedValue = useDebounce<T>(value: T, delay?: number)`
- Аргументы:
  - `value` — любое значение (generic)
  - `delay` — задержка в мс (по умолчанию 300)
- Возвращает: debouncedValue, обновляющийся только после задержки
- Пример:
  ```ts
  const [search, setSearch] = useState("");
  const debouncedSearch = useDebounce(search, 500);
  ```

#### Pagination (универсальный компонент)
- Переиспользуемый компонент серверной пагинации с иконками (shadcn/ui)
- API:
  - `page: number` — текущая страница
  - `total: number` — всего элементов
  - `limit?: number` — элементов на страницу (по умолчанию 10)
  - `onPageChange: (page: number) => void` — обработчик смены страницы
  - `className?: string` — стилизация
- Использует shadcn/ui Pagination, icon-кнопки, disable, расчёт totalPages
- Пример:
  ```tsx
  <Pagination page={page} total={total} limit={10} onPageChange={setPage} />
  ```
- Применён в админ-панели магазинов, рекомендуется для всех списков с серверной пагинацией

## Управление пользователями (admin/users)
- Универсальная форма UserForm для создания и редактирования пользователей.
- Поля: login (обяз.), роль, статус, магазин (для store_manager), password (обяз. при создании, опционален при редактировании).
- Валидация: login обязателен, пароль min 6 символов (только при создании обязателен), магазин обязателен для store_manager.
- В таблице и на странице пользователя статус отображается как цветной Badge, ID пользователя виден явно.
- Поиск по пользователям с debounce, пагинация через переиспользуемый компонент.
- PUT /admin/users/:id обновляет только переданные поля, включая пароль (с хешированием) и магазин (через data.store connect/disconnect).
- После успешного действия — toast, обновление данных, закрытие формы.
- Код чистый, без дублирования, с единым стилем, все импорты и типы приведены к корректному виду.

## Итог по админке
- Все функции управления пользователями реализованы: создание, редактирование, смена пароля, статусы, связь с магазином, валидация, UX.
- Используются современные UI-компоненты (shadcn/ui), адаптивность, UX.
- Код чистый, без дублирования, все импорты и типы приведены к корректному виду.
- Документация и changelog синхронизированы.
- Админка полностью соответствует ТЗ и стандарту проекта.

### API: Получение рассрочек клиента

Добавлен endpoint:
- `GET /api/client/customers/:id/installments` — возвращает все рассрочки клиента по id (только для текущего магазина).

Используется на детальной странице клиента для корректного отображения только его рассрочек.

### Глобальный поиск по паспорту
- Возвращает только магазины, где клиент либо в чёрном списке, либо с просрочкой
- На фронте результат отображается карточками: магазин, ФИО, статус, блокировка, список просрочек 

## Формат API-ответов

Все ответы backend теперь структурированы по единому стандарту:

- Успех:
  ```json
  { "success": true, "data": ..., "message": "..." }
  ```
- Ошибка:
  ```json
  { "success": false, "error": "Текст ошибки", "code": 400 }
  ```
- Ошибка валидации:
  ```json
  { "success": false, "error": "Ошибка валидации", "code": 422, "details": { ... } }
  ```

### Пагинация

Для всех методов, возвращающих список:
```json
{
  "success": true,
  "data": {
    "items": [...],
    "total": N,
    "page": N,
    "totalPages": N
  }
}
```

### Техническая реализация
- Глобальный интерцептор оборачивает все успешные ответы.
- Глобальный фильтр ошибок приводит все ошибки к единому формату.
- Тип ApiResponse на фронте полностью совместим с этим стандартом. 

## Преобразование id к number в контроллерах

- Все идентификаторы (id, storeId, customerId и др.), получаемые из params/query/body, преобразуются к типу number (`Number(id)`) непосредственно в контроллерах перед передачей в сервисы.
- Это необходимо для строгого соответствия типу Int в Prisma и предотвращения ошибок типов.
- Аналогично преобразуются все внешние ключи, если они приходят из строки.
- Решение принято после перехода на числовые id во всех моделях. 

## Детальная страница рассрочки (installments/[id])

На детальной странице рассрочки реализовано:
- Получение и отображение полной информации о рассрочке (клиент, сумма, срок, статус, график платежей)
- График платежей с возможностью оплаты каждого платежа (кнопка "Оплатить")
- Досрочное закрытие рассрочки:
  - Клиент может закрыть рассрочку досрочно в любой момент, если нет просроченных платежей (overdue или просроченных pending по дате).
  - Все неоплаченные платежи (pending) отменяются.
  - Создаётся один платёж с type = "early_payoff", status = "paid", amount = остаток основного долга (без процентов).
  - Рассрочка переводится в статус "early_payoff", totalAmount корректируется.
  - В истории платежей на фронте такой платёж выделяется и сопровождается пояснением: "Досрочное погашение, проценты не начислены".
- Отображение истории платежей, статусов, дат оплаты
- Все действия с платежами (оплата, просмотр, история) временно реализуются через эту страницу, отдельный модуль payments не используется

API:
- GET /api/client/installments/:id — получить рассрочку
- GET /api/client/installments/:id/payments — получить график платежей
- PUT /api/client/payments/:id/mark-paid — отметить платёж как оплаченный
- PUT /api/client/installments/:id/pay-off-early — досрочное закрытие рассрочки

UI/UX:
- Для каждого платежа отображается статус, сумма, дата, кнопка оплаты (если "pending" или "overdue")
- Для досрочного закрытия — диалог с подтверждением и расчётом остатка
- Вся логика реализована в front/src/pages/store/installments/[id].tsx 

## Импорт клиентов и рассрочек
Импорт данных доступен только для менеджеров магазинов через клиентский интерфейс. Реализован полный цикл импорта:

### Backend (модуль client/import)
- **ImportService** — обработка Excel файлов, валидация данных, создание записей
- **ImportController** — endpoints для загрузки файлов (`POST /client/import/clients`, `POST /client/import/installments`)
- Поддержка только .xlsx файлов
- Детальная валидация: обязательные поля, формат телефона, уникальность паспорта
- Обработка ошибок с указанием строки и описанием проблемы

### Frontend
- **ImportModal** — универсальное модальное окно для загрузки файлов

## Модуль платежей (payments)

### Backend API
- **PaymentsController** — управление платежами магазина
- **PaymentsService** — бизнес-логика платежей

#### Endpoints:
- `GET /api/client/payments` — список всех платежей с пагинацией и поиском
- `GET /api/client/payments/:id` — детали конкретного платежа
- `PUT /api/client/payments/:id/mark-paid` — отметить платёж как оплаченный
- `GET /api/client/payments/overdue` — просроченные платежи
- `GET /api/client/payments/upcoming` — предстоящие платежи (на неделю)

#### Бизнес-логика:
- **Оплата платежей**: система автоматически распределяет оплату по графику (сначала старые долги)
- **Частичная оплата**: поддерживается частичная оплата с перераспределением остатка
- **Перерасчёт графика**: при досрочной оплате остаток распределяется по оставшимся платежам
- **Автоматическое завершение**: когда все платежи оплачены, рассрочка получает статус "completed"

### Frontend страницы

#### 1. Список платежей (`/store/payments`)
- **Статистические карточки**: общая сумма, количество по статусам, средняя сумма
- **Фильтры**: по статусу (все, ожидают, оплачены, просрочены) и поиск
- **Улучшенная таблица**: аватары клиентов, детальная информация, быстрые действия
- **Отображение**: клиент с телефоном, товар с номером рассрочки, сумма, статус с временем до платежа, дата с днём недели
- **Действия**: просмотр деталей, быстрая оплата для ожидающих платежей
- **Статусы**: цветовая индикация с иконками и дополнительной информацией
- **Пагинация** и адаптивный дизайн
- Календарь доступен через отдельный пункт в боковом меню

#### 2. Детали платежа (`/store/payments/:id`)
- Полная информация о платеже и связанной рассрочке
- Информация о клиенте с переходом на профиль
- Детали рассрочки с переходом на рассрочку
- История платежа (создание, оплата, просрочка)
- Действия: "Отметить как оплаченный", "Позвонить клиенту"
- Автоматический расчёт просрочки в днях

#### 3. Календарь платежей (`/store/calendar`)
- Визуальный календарь с предстоящими платежами
- Статистика: предстоящие платежи, просрочки, сумма на неделю
- Отображение платежей в календарных днях
- Список просроченных платежей с контактами клиентов
- Навигация по месяцам
- Доступен через отдельный пункт в боковом меню

### Типы данных
```typescript
interface Payment {
  id: number
  installmentId: number
  amount: number
  status: string // 'pending', 'paid', 'overdue'
  dueDate: string
  paidDate: string | null
  installment: {
    id: number
    productName: string
    customer: {
      id: number
      firstName: string
      lastName: string
      phone: string
      // ... другие поля
    }
  }
  paymentHistory?: PaymentHistory[]
}

interface PaymentHistory {
  id: number
  paymentId: number
  amount: number
  paidDate: string
}
```

### Особенности реализации
- **Поиск**: по имени клиента, фамилии, названию товара
- **Фильтрация**: автоматическая по статусу (просроченные, предстоящие)
- **Валидация**: проверка принадлежности платежа магазину
- **Безопасность**: изоляция данных между магазинами
- **UX**: адаптивный дизайн, загрузочные состояния, обработка ошибок
- Кнопки импорта на страницах клиентов и рассрочек
- Скачивание шаблонов Excel файлов
- Отображение результатов импорта (успешно/ошибки)

### Тестовые файлы
- **clients_template.xlsx** — шаблон для импорта клиентов
- **installments_template.xlsx** — шаблон для импорта рассрочек  
- **clients_with_errors.xlsx** — файл с ошибками для тестирования валидации
- Скрипт **generate-test-excel.js** для создания тестовых файлов

### Валидация при импорте
- **Клиенты**: ФИО, паспорт (уникальность), телефон (+998XXXXXXXXX), адрес
- **Рассрочки**: существующий клиент, товар, цена, взнос, ставка, срок, логика (взнос < цена) 

## PWA (Progressive Web App)
Фронтенд поддерживает установку как PWA: реализован manifest.json, splash screen, иконки, meta-теги. Офлайн-режим и кеширование страниц не используются по требованиям безопасности и актуальности данных. 

## Дашборд магазина (обновлено 2024-07-16)

Дашборд магазина теперь содержит только ключевые метрики, сгруппированные по смыслу и визуально разделённые на два блока:

### 1. Рассрочки
- **Всего рассрочек**
- **Активные**
- **Просроченные** (выделено цветом)
- **Оборот за месяц**

### 2. Клиенты
- **Всего клиентов**
- **Активные клиенты**
- **В чёрном списке** (выделено цветом)

Карточки компактные, без дублирующих иконок и лишних подписей. Цветовые акценты используются только для важных метрик (просрочки, чёрный список). Вся второстепенная информация и процентные значения убраны для простоты восприятия.

Блоки визуально разделены (например, разными рядами или секциями). Остальные элементы дашборда (последние рассрочки, предстоящие платежи, быстрые действия) остаются без изменений, но статистика теперь максимально лаконична и не перегружает интерфейс. 